# 我们如何构建多代理研究系统

发布日期：2025年6月13日

我们的研究功能使用多个Claude代理来更有效地探索复杂主题。本文分享了构建这个系统时遇到的工程挑战以及我们从中吸取的教训。

Claude现在具备[研究能力](https://www.anthropic.com/news/research)，可以跨网络、Google
Workspace和任何集成进行搜索，以完成复杂任务。

这个多代理系统从原型到生产的旅程教会了我们关于系统架构、工具设计和提示工程的关键教训。多代理系统由多个代理（LLM在循环中自主使用工具）组成，它们协同工作。我们的研究功能涉及一个代理，该代理根据用户查询制定研究过程，然后使用工具创建并行代理来同时搜索信息。包含多个代理的系统在代理协调、评估和可靠性方面带来了新的挑战。

本文将分解对我们有效的原则——我们希望您在构建自己的多代理系统时会发现它们很有用。

### 多代理系统的好处

研究工作涉及开放式问题，很难提前预测所需的步骤。您无法为探索复杂主题硬编码固定路径，因为这个过程本质上是动态的且依赖路径的。当人们进行研究时，他们往往会根据发现不断更新方法，遵循调查中出现的线索。

这种不可预测性使AI代理特别适合研究任务。研究需要灵活性，能够在调查展开时进行转折或探索切向的联系。模型必须自主运行许多轮次，根据中间发现决定追求哪些方向。线性的、单次流水线无法处理这些任务。

搜索的本质是压缩：从大量语料库中提炼见解。子代理通过在独立上下文窗口中并行操作来促进压缩，同时探索问题的不同方面，然后为首席研究代理压缩最重要的标记。每个子代理还提供关注点分离——不同的工具、提示和探索轨迹——这减少了路径依赖性，并实现彻底、独立的调查。

一旦智能达到某个阈值，多代理系统就成为扩展性能的关键方式。例如，尽管个人在过去10万年中变得更加聪明，但人类社会在信息时代由于我们的集体智能和协调能力而变得指数级更有能力。即使是一般智能的代理作为个体运作时也面临限制；代理群体可以完成更多事情。

我们的内部评估表明，多代理研究系统特别擅长需要同时追求多个独立方向的广度优先查询。我们发现，使用Claude Opus
4作为首席代理和Claude Sonnet 4子代理的多代理系统在我们内部研究评估上的表现优于单代理Claude Opus
4，达到90.2%。例如，当被要求识别信息技术标准普尔500指数中所有公司的董事会成员时，多代理系统通过将任务分解为子代理来找到正确答案，而单代理系统因缓慢的顺序搜索而失败。

多代理系统主要有效的原因是它们帮助花费足够的代币来解决问题。在我们的分析中，三个因素解释了[BrowseComp](https://openai.com/index/browsecomp/)评估中95%的性能差异（该评估测试浏览代理定位难以查找信息的能力）。我们发现，仅代币使用就解释了80%的差异，其余两个解释因素是工具调用次数和模型选择。这一发现验证了我们的架构，即通过具有独立上下文窗口的代理分配工作，以增加并行推理的能力。最新的Claude模型作为代币使用的大效率乘数发挥作用，因为升级到Claude
Sonnet 4的性能提升大于在Claude Sonnet 3.7上加倍代币预算。多代理架构有效地为超出单代理限制的任务扩展代币使用。

有一个缺点：在实践中，这些架构消耗代币很快。在我们的数据中，代理通常比聊天交互多使用约4倍的代币，而多代理系统比聊天多使用约15倍的代币。为了经济可行性，多代理系统需要任务价值足够高以支付增加的性能。此外，一些需要所有代理共享相同上下文或涉及代理之间许多依赖关系的领域目前不适合多代理系统。例如，大多数编码任务的可并行化任务比研究少，而且LLM代理在实时协调和委派给其他代理方面还不擅长。我们发现多代理系统在涉及大量并行化、信息超出单个上下文窗口、以及与许多复杂工具接口的有价值任务上表现出色。

### 研究架构概述

我们的研究系统使用多代理架构，采用编排器-工作模式，其中首席代理协调过程，同时委派在并行中运行的专门子代理。

![多代理架构示意图](https://www-cdn.anthropic.com/images/4zrzovbb/website/1198befc0b33726c45692ac40f764022f4de1bf2-4584x2579.png)

多代理架构运作中：用户查询通过创建专门子代理以并行搜索不同方面的首席代理。

当用户提交查询时，首席代理分析它，制定策略，并生成子代理同时探索不同方面。如上图所示，子代理充当智能过滤器，通过迭代使用搜索工具来收集信息（本例中是关于2025年AI代理公司），然后返回公司列表给首席代理以编制最终答案。

传统方法使用检索增强生成（RAG）使用静态检索。也就是说，它们获取与输入查询最相似的一些块，并使用这些块生成响应。相比之下，我们的架构使用多步搜索，动态查找相关信息，适应新发现，并分析结果以制定高质量答案。

![研究系统完整工作流程图](https://www-cdn.anthropic.com/images/4zrzovbb/website/3bde53c9578d74f6e05c3e515e20b910c5a8c20a-4584x4584.png)

显示我们多代理研究系统完整工作流程的过程图。当用户提交查询时，系统创建一个LeadResearcher代理，该代理进入迭代研究过程。LeadResearcher首先思考方法并将其计划保存到Memory以保留上下文，因为如果上下文窗口超过200,000个标记，它将被截断，保留计划很重要。然后创建具有特定研究任务的专门Subagents（这里显示了两个，但可以是任意数量）。每个Subagent独立执行网络搜索，使用[交错思考](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking#interleaved-thinking)评估工具结果，并将发现返回给LeadResearcher。LeadResearcher综合这些结果并决定是否需要更多研究——如果是，它可以创建额外的子代理或完善其策略。一旦收集了足够的信息，系统退出研究循环并将所有发现传递给CitationAgent，该代理处理文档和研究报告以识别引用的具体位置。这确保了所有声明都正确归因于其来源。最终的研究结果（包含引文）然后返回给用户。

### 研究代理的提示工程和评估

多代理系统与单代理系统有关键区别，包括协调复杂性的快速增长。早期代理犯了这样的错误：为简单查询生成50个子代理，没完没了地为不存在的来源搜索网络，以及用过多的更新相互干扰。由于每个代理都由提示引导，提示工程是我们改善这些行为的主要杠杆。以下是我们学到的关于提示代理的一些原则：

1. **像您的代理一样思考。**
   要迭代提示，您必须了解它们的效果。为了帮助我们做到这一点，我们使用我们的[Console](https://console.anthropic.com/)构建了模拟，使用我们系统中的确切提示和工具，然后观察代理逐步工作。这立即揭示了失败模式：代理在已有足够结果时继续，使用过于冗长的搜索查询，或选择错误的工具。有效的提示依赖于开发代理的准确心智模型，这可以使最 impactful 的更改变得明显。

2. **教编排器如何委派。**
   在我们的系统中，首席代理将查询分解为子任务并向子代理描述它们。每个子代理需要一个目标、输出格式、关于使用哪些工具和来源的指导，以及明确的任务边界。如果没有详细的任务描述，代理会重复工作、留下空白或无法找到必要的信息。我们开始时允许首席代理给出简单、短的指令，如"研究半导体短缺"，但发现这些指令往往足够模糊，子代理会误解任务或执行与其他代理完全相同的搜索。例如，一个子代理探索了2021年汽车芯片危机，而另外两个子代理重复调查当前的2025年供应链，却没有有效的劳动分工。

3. **根据查询复杂性扩展工作量。**
   代理难以判断不同任务的适当工作量，因此我们在提示中嵌入缩放规则。简单的事实查找只需要1个代理和3-10次工具调用，直接比较可能需要2-4个子代理，每个10-15次调用，复杂研究可能使用超过10个子代理，具有明确划分的职责。这些明确的指导方针帮助首席代理有效分配资源，防止在简单查询上过度投资，这在我们早期版本中是一种常见的失败模式。

4. **工具设计和选择至关重要。**
   代理工具界面与人机界面同样关键。使用正确的工具是高效的——通常，这是绝对必要的。例如，在Slack中只存在的上下文，而代理在网络上搜索，注定从一开始就失败了。通过[ MCP服务器](https://modelcontextprotocol.io/introduction)让模型访问外部工具，这个问题会加剧，因为代理会遇到质量描述差异很大的未见工具。我们给代理明确的启发式方法：例如，首先检查所有可用工具，将工具使用与用户意图匹配，在网络上进行广泛的外部探索，或优先使用专门工具而不是通用工具。糟糕的工具描述可能会使代理完全走上错误的道路，因此每个工具都需要明确的目的和清晰的描述。

5. **让代理改进自己。** 我们发现Claude
   4模型可以是优秀的提示工程师。当给出提示和失败模式时，它们能够诊断代理失败的原因并建议改进。我们甚至创建了一个工具测试代理——当给出有缺陷的MCP工具时，它尝试使用该工具，然后重写工具描述以避免失败。通过测试工具数十次，这个代理发现了关键细微差别和错误。这种改进工具人体工程学的过程使未来使用新描述的代理任务完成时间减少了40%，因为它们能够避免大多数错误。

6. **先广后窄。**
   搜索策略应该反映专家人类研究：在深入具体之前先探索领域。代理通常默认使用过于冗长、具体的查询，返回很少的结果。我们通过提示代理从简短、广泛的查询开始，评估可用的内容，然后逐步缩小范围来对抗这种倾向。

7. **指导思考过程。**
   [扩展思考模式](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)，使Claude在可见的思考过程中输出额外的标记，可以作为可控的草稿纸。首席代理使用思考来计划其方法，评估哪些工具适合任务，确定查询复杂性和子代理数量，以及定义每个子代理的角色。我们的测试表明，扩展思考改善了指令遵循、推理和效率。子代理也进行规划，然后在工具结果后使用[交错思考](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking#interleaved-thinking)来评估质量、识别差距并优化其下一次查询。这使子代理更能适应任何任务。

8. **并行工具调用改变速度和性能。**
   复杂的研究任务自然涉及探索许多来源。我们早期的代理执行顺序搜索，这非常慢。为了速度，我们引入了两种并行化：(1)首席代理并行生成3-5个子代理而不是串行；(2)子代理并行使用3个以上工具。这些变化将复杂查询的研究时间减少了高达90%，使Research能够在几分钟内完成更多工作，而不是数小时，同时比其他系统覆盖更多信息。

我们的提示策略专注于灌输良好的启发式方法而不是 rigid 规则。我们研究熟练的人类如何处理研究任务，并将这些策略编码到我们的提示中——策略如将困难问题分解为更小的任务、仔细评估来源质量、根据新信息调整搜索方法，以及认识到何时专注于深度（详细调查一个主题） vs 广度（并行探索许多主题）。我们还通过设置明确的护栏来主动缓解意外副作用，防止代理失控。最后，我们专注于具有可观察性和测试用例的快速迭代循环。

### 代理的有效评估

构建可靠的AI应用程序需要良好的评估，代理也不例外。然而，评估多代理系统带来独特的挑战。传统评估通常假设AI遵循相同的步骤：给定输入X，系统应遵循路径Y产生输出Z。但多代理系统并非如此。即使有相同的起点，代理也可能采取完全不同的有效路径来实现其目标。一个代理可能搜索三个来源，而另一个搜索十个，或者它们可能使用不同的工具找到相同的答案。因为我们并不总是知道正确的步骤是什么，我们通常不能只是检查代理是否遵循我们预先规定的"正确"步骤。相反，我们需要灵活的评估方法来判断代理是否实现了正确的结果，同时也遵循合理的过程。

**用小样本立即开始评估。**
在代理开发的早期，变化往往产生巨大影响，因为有大量唾手可得的果实。提示调整可能将成功率从30%提高到80%。由于效果规模这么大，您只需几个测试用例就能发现变化。我们从大约20个代表真实使用模式的查询开始。测试这些查询通常让我们清楚地看到变化的影响。我们经常听到AI开发团队推迟创建评估，因为他们认为只有具有数百个测试用例的大型评估才有用。然而，最好立即用几个例子开始小规模测试，而不是延迟到可以构建更彻底的评估时。

**做得好时，LLM作为法官的评估可以扩展。**
研究输出很难程序化评估，因为它们是自由形式的文本，很少有单一正确答案。LLM是评分输出的自然选择。我们使用了一个LLM法官，根据评分标准评估每个输出：事实准确性（声明是否与来源匹配？）、引用准确性（引用的来源是否与声明匹配？）、完整性（是否涵盖了所有要求的方面？）、来源质量（它是否使用了一级来源而不是质量较低的二级来源？）、以及工具效率（它是否以合理的次数使用了正确的工具？）。我们尝试了多个法官来评估每个组件，但发现具有单个提示的单个LLM调用输出0.0-1.0的分数和通过-不通过等级是最一致的，与人类判断一致。当评估测试用例确实有明确答案时，这种方法特别有效，我们可以使用LLM法官简单地检查答案是否正确（例如，它是否准确列出了研发预算前三大的制药公司？）。使用LLM作为法官使我们能够可扩展地评估数百个输出。

**人工评估捕捉自动化遗漏的内容。**
人们测试代理会发现评估遗漏的边缘情况。这包括对不寻常查询的幻觉答案、系统故障或细微的来源选择偏见。在我们的情况下，人工测试人员注意到我们早期的代理一致选择SEO优化的内容农场，而不是权威但排名较低的来源，如学术PDF或个人博客。在提示中添加来源质量启发式方法帮助解决了这个问题。即使在自动化评估的世界中，手动测试仍然至关重要。

多代理系统具有突发行为，这些行为在没有特定编程的情况下出现。例如，对首席代理的微小更改可以不可预测地改变子代理的行为。成功需要理解交互模式，而不仅仅是单个代理的行为。因此，这些代理的最佳提示不仅仅是严格指令，而是协作框架，定义了劳动分工、问题解决方法和工作预算。正确地做到这一点依赖于仔细的提示和工具设计、可靠的启发式方法、可观察性以及紧密的反馈循环。请参阅我们[Cookbook中的开源提示](https://github.com/anthropics/anthropic-cookbook/tree/main/patterns/agents/prompts)查看我们系统中的示例提示。

### 生产可靠性和工程挑战

在传统软件中，错误可能会破坏功能、降低性能或导致中断。在代理系统中，微小的更改会级联成大的行为变化，这使得为必须在长时间运行过程中维护状态的复杂代理编写代码变得非常困难。

**代理是有状态的，错误会累积。**
代理可以运行很长时间，在许多工具调用中维护状态。这意味着我们需要持久地执行代码并沿途处理错误。没有有效的缓解措施，微小的系统故障对代理来说可能是灾难性的。当错误发生时，我们不能只是从一开始就重新启动：重启对于用户来说是昂贵的和令人沮丧的。相反，我们构建了系统，能够在错误发生时从代理所在的位置恢复。我们还利用模型的智能来优雅地处理问题：例如，让代理知道工具何时失败并让它适应，效果出奇地好。我们将基于Claude构建的AI代理的适应性结合与确定性保护措施（如重试逻辑和定期检查点）相结合。

**调试受益于新方法。**
代理做出动态决策，并且在相同提示下运行之间是不确定的。这使得调试更加困难。例如，用户会报告代理"找不到明显的信息"，但我们看不到原因。代理使用了糟糕的搜索查询？选择了糟糕的来源？遇到了工具故障？添加完整的生产跟踪让我们能够诊断代理失败的原因并系统地修复问题。除了标准可观察性之外，我们监控代理决策模式和交互结构——所有这些都不监控个人对话的内容，以维护用户隐私。这种高级别的可观察性帮助我们诊断根本原因、发现意外行为并修复常见故障。

**部署需要仔细协调。**
代理系统是高度有状态的提示、工具和执行逻辑网络，几乎连续运行。这意味着每当我们部署更新时，代理可能处于流程中的任何位置。因此，我们需要防止我们善意的代码更改破坏现有代理。我们不能同时将每个代理更新到新版本。相反，我们使用[彩虹部署](https://brandon.dimcheff.com/2018/02/rainbow-deploys-with-kubernetes/)来避免干扰运行中的代理，通过在保持两个版本同时运行的同时逐渐将流量从旧版本转移到新版本。

**同步执行造成瓶颈。**
目前，我们的首席代理同步执行子代理，等待每组子代理完成后再继续。这简化了协调，但在代理之间的信息流中造成了瓶颈。例如，首席代理无法引导子代理，子代理无法协调，整个系统可能在等待单个子代理完成搜索时被阻塞。异步执行将实现额外的并行性：代理同时工作并在需要时创建新的子代理。但这种异步性在子代理之间的结果协调、状态一致性和错误传播方面增加了挑战。随着模型可以处理更长、更复杂的研究任务，我们预计性能增益将证明复杂性的合理性。

### 结论

构建AI代理时，最后一英里往往成为大部分旅程。在开发者机器上工作的代码库需要大量的工程努力才能成为可靠的生产系统。代理系统中错误的复合性质意味着对于传统软件来说是微小的问题可能完全使代理脱轨。一个步骤失败可能导致代理探索完全不同的轨迹，导致不可预测的结果。由于本文描述的所有原因，原型与生产之间的差距往往比预期的要大。

尽管存在这些挑战，多代理系统已被证明对开放式研究任务有价值。用户说Claude帮助他们找到了未曾考虑的商业机会，驾驭复杂的医疗选择，解决棘手的技术错误，并通过揭示他们自己不会发现的研究联系来节省多达数天的工作。多代理研究系统可以通过仔细的工程、全面的测试、注重细节的提示和工具设计、稳健的运营实践，以及研究、产品和工程团队之间的紧密协作（他们对当前代理能力有深入的理解）可靠地大规模运行。我们已经看到这些系统正在改变人们解决复杂问题的方式。

![Clio嵌入图](https://www-cdn.anthropic.com/images/4zrzovbb/website/09a90e0aca54859553e93c18683e7fd33ff16d4c-2654x2148.png)

显示人们今天使用Research功能的最常见方式的[Clio](https://www.anthropic.com/research/clio)嵌入图。首要用例类别是跨专门领域开发软件系统（10%）、开发和优化专业和技术内容（8%）、制定业务增长和收入生成策略（8%）、协助学术研究和教育材料开发（7%），以及研究和验证有关人员、地点或组织的信息（5%）。

### 致谢

由Jeremy Hadfield、Barry Zhang、Kenneth Lien、Florian Scholz、Jeremy Fox和Daniel
Ford撰写。这项工作反映了Anthropic多个团队使研究功能成为可能的集体努力。特别感谢Anthropic应用工程团队，他们致力于将这个复杂的多代理系统投入生产。我们也感谢早期用户的出色反馈。

## 附录

以下是关于多代理系统的一些额外杂项提示。

**评估在多轮中改变状态的代理的最终状态评估。**
评估在多轮对话中修改持久状态的代理带来了独特的挑战。与只读研究任务不同，每个动作都可以为后续步骤改变环境，创建传统评估方法难以处理的依赖关系。我们成功地将重点放在最终状态评估上，而不是逐轮分析。不是判断代理是否遵循了特定过程，而是评估它是否实现了正确的最终状态。这种方法承认代理可能找到达到相同目标的替代路径，同时仍然确保它们交付预期的结果。对于复杂的工作流，将评估分解为代理应该发生特定状态变化的离散检查点，而不是试图验证每个中间步骤。

**长程对话管理。**
生产代理经常参与跨越数百轮的对话，需要仔细的上下文管理策略。随着对话延长，标准上下文窗口变得不足，需要智能压缩和记忆机制。我们实现了代理在进入新任务之前总结已完成的工作阶段并将基本信息存储在外部记忆中的模式。当上下文限制接近时，代理可以生成具有干净上下文的新子代理，同时通过仔细的交接保持连续性。此外，它们可以从记忆中检索存储的上下文（如研究计划），而不是在达到上下文限制时丢失之前的工作。这种分布式方法防止上下文溢出，同时保持跨扩展交互的对话连贯性。

**子代理输出到文件系统以最小化"传话游戏"。**
某些类型的结果可以直接绕过主要协调器，改善保真度和性能。不需要求所有子代理都通过首席代理进行通信，而是实现工件系统，专门代理可以在其中创建独立存在的输出。子代理调用工具将其工作存储在外部系统，然后将轻量级引用传递回协调器。这防止了多阶段处理中的信息丢失，并减少了通过对话历史复制大输出的令牌开销。这种模式对于结构化输出（如代码、报告或数据可视化）效果特别好，子代理的专业提示比通过一般协调器过滤产生更好的结果。

---

![互锁拼图，具有复杂几何形状和详细表面纹理](https://www-cdn.anthropic.com/images/4zrzovbb/website/43abe7e54b56a891e74a8542944dfbd33f07f49c-1000x1000.svg)

### 想了解更多？

探索课程

[/learn](https://anthropic.skilljar.com/)

## 获取开发者通讯

产品更新、操作指南、社区焦点等。每月发送到您的收件箱。

如果您想接收我们的月度开发者通讯，请提供您的电子邮件地址。您可以随时取消订阅。

[](/)

### 产品

- [Claude](https://www.claude.com/product/overview)
- [Claude Code](https://www.claude.com/product/claude-code)
- [Chrome中的Claude](https://www.claude.com/chrome)
- [Excel中的Claude](https://www.claude.com/claude-in-excel)
- [Slack中的Claude](https://www.claude.com/claude-in-slack)
- [技能](https://www.claude.com/skills)
- [Max计划](https://www.claude.com/pricing/max)
- [团队计划](https://www.claude.com/pricing/team)
- [企业计划](https://www.claude.com/pricing/enterprise)
- [下载应用](https://www.claude.ai/download)
- [定价](https://www.claude.com/pricing)
- [登录Claude](https://www.claude.ai/)

### 模型

- [Opus](https://www.anthropic.com/claude/opus)
- [Sonnet](https://www.anthropic.com/claude/sonnet)
- [Haiku](https://www.anthropic.com/claude/haiku)

### 解决方案

- [AI代理](https://www.claude.com/solutions/agents)
- [代码现代化](https://www.claude.com/solutions/code-modernization)
- [编码](https://www.claude.com/solutions/coding)
- [客户支持](https://www.claude.com/solutions/customer-support)
- [教育](https://www.claude.com/solutions/education)
- [金融服务](https://www.claude.com/solutions/financial-services)
- [政府](https://www.claude.com/solutions/government)
- [生命科学](https://www.claude.com/solutions/life-sciences)
- [非营利组织](https://www.claude.com/solutions/nonprofits)

### Claude开发者平台

- [概述](https://www.claude.com/platform/api)
- [开发者文档](https://platform.claude.com/docs)
- [定价](https://www.claude.com/pricing#api)
- [区域合规](https://www.claude.com/regional-compliance)
- [Amazon Bedrock](https://www.claude.com/partners/amazon-bedrock)
- [Google Cloud的Vertex AI](https://www.claude.com/partners/google-cloud-vertex-ai)
- [Console登录](http://console.anthropic.com/)

### 学习

- [博客](https://www.claude.com/blog)
- [Claude合作伙伴网络](https://www.claude.com/partners)
- [连接器](https://www.claude.com/connectors)
- [课程](/learn)
- [客户案例](https://www.claude.com/customers)
- [Anthropic的工程](/engineering)
- [活动](/events)
- [由Claude驱动](https://www.claude.com/partners/powered-by-claude)
- [服务合作伙伴](https://www.claude.com/partners/services)
- [初创公司计划](https://www.claude.com/programs/startups)
- [教程](https://www.claude.com/resources/tutorials)
- [用例](https://www.claude.com/resources/use-cases)

### 公司

- [Anthropic](/company)
- [职业](/careers)
- [经济期货](/economic-index)
- [研究](/research)
- [新闻](/news)
- [负责任扩展政策](https://www.anthropic.com/news/announcing-our-updated-responsible-scaling-policy)
- [安全和合规](https://trust.anthropic.com/)
- [透明度](/transparency)

### 帮助和安全

- [可用性](https://www.anthropic.com/supported-countries)
- [状态](https://status.anthropic.com/)
- [支持中心](https://support.claude.com/en/)

### 条款和政策

- [隐私政策](https://www.anthropic.com/legal/privacy)
- [负责任披露政策](https://www.anthropic.com/responsible-disclosure-policy)
- [服务条款：商业](https://www.anthropic.com/legal/commercial-terms)
- [服务条款：消费者](https://www.anthropic.com/legal/consumer-terms)
- [使用政策](https://www.anthropic.com/legal/aup)

© 2025 Anthropic PBC

- [](https://www.linkedin.com/company/anthropicresearch)
- [](https://x.com/AnthropicAI)
- [](https://www.youtube.com/@anthropic-ai)

我们如何构建多代理研究系统 \ Anthropic
